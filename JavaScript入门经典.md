# JavaScript高级程序设计

## 第11章 期约与异步函数

### 11.1 异步编程

1、在JavaScript这种单线程事件循环模型中，同步操作与异步操作是代码所要依赖的核心机制。

2、异步行为是为了优化因计算量大而时间长的操作。如果在等待其他操作完成的同时，即使运行其他指令，系统也能保持稳定，那么这样做就是务实的。

3、异步操作并不一定计算量大或要等很长时间。只要你不想为等待某个异步操作而阻塞线程执行，那么任何时候都可以使用。

**11.1.1 同步与异步**

1、同步行为对应内存中顺序执行的处理器指令。每条指令都会严格按照它们出现的顺序来执行，而每条指令执行后也能立即获得存储在系统本地（如寄存器或系统内存）的信息。这样的执行流程容易分析程序在执行到代码任意位置时的状态（比如变量的值）。

2、异步行为类似于系统中断，即当前进程外部的实体可以触发代码执行。异步操作经常是必要的，因为强制进程等待一个长时间的操作通常是不可行的（同步操作则必须要等）。如果代码要访问一些高延迟的资源，比如向远程服务器发送请求并等待响应，那么就会出现长时间的等待。

3、异步代码不容易推断。执行异步操作会生成一个入队执行的中断。到底什么时候会触发这个中断，这对JavaScript运行时来说是一个黑盒，因此实际上无法预知。

**11.1.2 以往的异步编程模式**

1、在早期的JavaScript中，只支持定义回调函数来表明异步操作完成。串联多个异步操作是一个常见的问题，通常需要深度嵌套的回调函数（俗称“回调地狱”）来解决。

异步操作的失败处理在回调模型中也要考虑，因此自然就出现了成功回调和失败回调。

2、随着代码越来越复杂，回调策略是不具有扩展性的。“回调地狱”这个称呼可谓名至实归。嵌套回调的代码维护起来就是噩梦。

### 11.2 期约

1、期约是对尚不存在结果的一个替身。

2、ECMAScript 6增加了Promise类型。一经推出，Promise就大受欢迎，成为了主导性的异步编程机制。

**11.2.1 Promises/A+规范**

1、所有现代浏览器都支持ES6期约，很多其他浏览器API（如fetch()和Battery Status API）也以期约为基础。

**11.2.2 期约基础**

1、ECMAScript 6新增的引用类型Promise，可以通过new操作符来实例化。创建新期约时需要传入执行器（executor）函数作为参数。

### 11.3 异步函数

1、异步函数，也称为“async/await”（语法关键字），是ES6期约模式在ECMAScript函数中的应用。

async/await是ES8规范新增的。这个特性从行为和语法上都增强了JavaScript，让以同步方式写的代码能够异步执行。

2、期约是一个有状态的对象，可能处于如下3种状态之一：待定，兑现，拒绝。

3、待定（pending）是期约的最初始状态。在待定状态下，期约可以落定（settled）为代表成功的兑现（fulfilled）状态，或者代表失败的拒绝（rejected）状态。无论落定为哪种状态都是不可逆的。

组织合理的代码无论期约解决（resolve）还是拒绝（reject），甚至永远处于待定（pending）状态，都应该具有恰当的行为。

4、期约抽象地表示一个异步操作。期约的状态代表期约是否完成。“待定”表示尚未开始或者正在执行中。“兑现”表示已经成功完成，而“拒绝”则表示没有成功完成。

5、每个期约只要状态切换为兑现，就会有一个私有的内部值（value）。类似地，每个期约只要状态切换为拒绝，就会有一个私有的内部理由（reason）。

在期约到达某个落定状态时执行的异步代码始终会收到这个值或理由。

6、执行器函数主要有两项职责：初始化期约的异步行为和控制状态的最终转换。其中，控制期约状态的转换是通过调用它的两个函数参数实现的。

控制期约状态的转换是通过调用它的两个函数参数实现的。这两个函数参数通常都命名为resolve()和reject()。调用resolve()会把状态切换为兑现，调用reject()会把状态切换为拒绝。

7、通过调用Promise.resolve()静态方法，可以实例化一个解决的期约。使用这个静态方法，实际上可以把任何值都转换为一个期约。

对这个静态方法而言，如果传入的参数本身是一个期约，那它的行为就类似于一个空包装。因此，Promise.resolve()可以说是一个幂等方法。

## 附录D JavaScript工具

### D.1 包管理

1、第三方库也称为“包”，托管在公开代码仓库中。

2、JavaScript包管理器可以管理项目依赖的包，涉及获取和安装，以及版本控制。

3、包管理器提供了命令行界面，用于安装和删除项目依赖。项目的配置通常存储在项目本地的配置文件中。

**D.1.1 npm**

1、npm，即Node包管理器（Node Package Manager），是Node.js运行时默认的包管理器。

2、在npm仓库中发布的第三方包可以指定为项目依赖，并通过命令行本地安装。

3、npm仓库包含服务端和客户端JavaScript库。

4、在安装包时，npm使用嵌套依赖树解析所有项目依赖，每个项目依赖都会安装自己的依赖。这意味着如果项目依赖三个包A、B和C，而这三个包又都依赖不同版本的D，则npm会安装包D的三个版本。

> 另外还有Bower和JSPM两个包管理器

**D.1.4 Yarn**

1、Yarn是Facebook开发的定制包管理器，从很多方面看是npm的升级版。

2、Yarn和npm的主要区别是提供了加速安装、包缓存、锁文件等功能，且提供了改进了包安全功能。

