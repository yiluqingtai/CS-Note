# Docker技术入门与实践

## 第一部分 基础入门

### 第1章 初始docker和容器

1、在云时代，最看重的是凭借虚拟化技术所构建的集群处理能力。

2、虚拟化发展进程：大型主机虚拟化，以Xen、KVM为代表的虚拟机虚拟化，以Docker为代表的容器技术。

3、容器技术充分利用了操作系统本身已有的机制和特性，可以实现远超传统虚拟机的轻量级虚拟化。

#### 1.1 什么是Docker

1、Docker是基于Go语言实现的开源容器项目。

2、Docker通过对应用的封装（Packaging）、分发（Distribution）、部署（Deployment）、运行（Runtime）生命周期进行管理，达到应用组件级别的“一次封装，到处运行”。

3、可以将Docker容器理解为一种轻量级的沙盒（sandbox）。每个容器内运行着一个应用，不同的容器相互隔离，容器之间也可以通过网络互相通信。

#### 1.2 为什么要使用Docker

1、Docker通过容器来打包应用、解耦应用和运行平台。这意味着迁移的时候，只需要在新的服务器上启动需要的容器就可以了，无论新旧服务器是否是同一类型的平台。这无疑将帮助我们节约大量的宝贵时间，并降低部署过程出现问题的风险。

#### 1.3 Docker与虚拟化

1、在计算机技术中，虚拟化是一种资源管理技术，是将计算机的各种实体资源，如服务器、网络、内存及存储等，予以抽象、转换后呈现出来，打破实体结构间的不可切割的障碍，使用户可以用比原本的组态更好的方式来应用这些资源。

2、传统方式是在硬件层面实现虚拟化，需要有额外的虚拟机管理应用和虚拟机操作系统层。Docker容器是在操作系统层面上实现虚拟化，直接复用本地主机的操作系统，因此更加轻量级。

### 第2章 核心概念与安装配置

1、Docker三大核心概念：镜像、容器和仓库。

#### 2.1 核心概念

1、Docker镜像类似于虚拟机镜像，可以将它理解为一个只读的模板。镜像是创建Docker容器的基础。

2、Docker容器类似于一个轻量级的沙箱，Docker利用容器来运行和隔离应用。容器是从镜像创建的应用运行实例。它可以启动、开始、停止、删除，而这些容器都是彼此相互隔离、互不可见的。

3、Docker仓库类似于代码仓库，是Docker集中存放镜像文件的场所。

仓库注册服务器是存放仓库的地方，其上往往存放着多个仓库。每个仓库集中存放某一类镜像，往往包括多个镜像文件，通过不同的标签（tag）来进行区分。

Docker利用仓库管理镜像的设计理念与Git代码仓库的概念非常相似，实际上Docker设计上借鉴了Git的很多优秀思想。

#### 2.2 安装Docker引擎

#### 2.3 配置Docker服务

1、为了避免每次使用Docker命令时都需要切换到特权身份，可以将当前用户加入安装中自动创建的docker用户组。

2、Docker服务启动时实际上是调用了dockerd命令，支持多种启动参数。因此，用户可以直接通过执行dockerd命令来启动Docker服务。

#### 2.4 推荐实践环境

### 第3章 使用Docker镜像

1、Docker运行容器前需要本地存在对应的镜像，如果镜像不存在，Docker会尝试先从默认镜像仓库下载（默认使用Docker Hub公共注册服务器中的仓库），用户也可以通过配置，使用自定义的镜像仓库。

#### 3.1 获取镜像

1、可以使用docker [image] pull命令直接从Docker Hub镜像源来下载镜像。该命令的格式为docker[image] pull NAME[:TAG]。

2、对于Docker镜像来说，如果不显式指定TAG，则默认会选择latest标签，这会下载仓库中最新版本的镜像。

3、镜像文件一般由若干层（layer）组成，6c953ac5d795这样的串是层的唯一id（实际上完整的id包括256比特，64个十六进制字符组成）。使用docker pull命令下载中会获取并输出镜像的各层信息。当不同的镜像包括相同的层时，本地仅存储了层的一份内容，减小了存储空间。

#### 3.2 查看镜像信息

1、使用docker images或docker image ls命令可以列出本地主机上已有镜像的基本信息。

2、其中镜像的ID信息十分重要，它唯一标识了镜像。在使用镜像ID的时候，一般可以使用该ID的前若干个字符组成的可区分串来替代完整的ID。

3、为了方便在后续工作中使用特定镜像，还可以使用docker tag命令来为本地镜像任意添加新的标签。

4、使用docker[image]inspect命令可以获取该镜像的详细信息，包括制作者、适应架构、各层的数字摘要等。

5、history子命令列出各层的创建信息。

#### 3.3 搜寻镜像

1、使用docker search命令可以搜索Docker Hub官方仓库中的镜像。语法为docker search [option] keyword。

#### 3.4 删除和清理镜像

1、使用docker rmi或docker image rm命令可以删除镜像，命令格式为docker rmi IMAGE[IMAGE...]，其中IMAGE可以为标签或ID。

2、使用Docker一段时间后，系统中可能会遗留一些临时的镜像文件，以及一些没有被使用的镜像，可以通过docker image prune命令来进行清理。

#### 3.5 创建镜像

1、创建镜像的方法主要有三种：基于已有镜像的容器创建、基于本地模板导入、基于Dockerfile创建。

2、基于已有镜像的容器创建主要是使用docker [container] commit命令。

3、用户也可以直接从一个操作系统模板文件导入一个镜像，主要使用docker [container] import命令。命令格式为docker [image] import [OPTIONS] file|URL|-[REPOSITORY [:TAG]]

4、基于Dockerfile创建是最常见的方式。Dockerfile是一个文本文件，利用给定的指令描述基于某个父镜像创建新镜像的过程。

#### 3.6 存出和载入镜像

1、用户可以使用docker [image] save和docker[image] load命令来存出和载入镜像。

2、如果要导出镜像到本地文件，可以使用docker [image] save命令。

3、可以使用docker [image] load将导出的tar文件再导入到本地镜像库。

#### 3.7 上传镜像

1、可以使用docker [image] push命令上传镜像到仓库，默认上传到Docker Hub官方仓库（需要登录）。命令格式为docker [image] push NAME[:TAG] |[REGISTRY_HOST[:REGISTRY_PORT]/]NAME[:TAG]。

### 第4章 操作Docker容器

1、容器是镜像的一个运行实例。所不同的是，镜像是静态的只读文件，而容器带有运行时需要的可写文件层，同时，容器中的应用进程处于运行状态。

#### 4.1 创建容器

1、可以使用docker [container] create命令新建一个容器。

2、由于容器是整个Docker技术栈的核心，create命令和后续的run命令支持的选项都十分复杂，需要读者在实践中不断体会。

3、-i选项：保持标准输入打开；-t选项：分配一个伪终端。

4、使用docker [container] start命令来启动一个已经创建的容器。

5、除了创建容器后通过start命令来启动，也可以直接新建并启动容器。所需要的命令主要为docker [container] run，等价于先执行docker [container] create命令，再执行docker [container] start命令。

6、docker run甚至可以自动下载镜像、创建容器并运行容器。

7、对于所创建的bash容器，当用户使用exit命令退出bash进程之后，容器也会自动退出。这是因为对于容器来说，当其中的应用退出后，容器的使命完成，也就没有继续运行的必要了。

8、更多的时候，需要让Docker容器在后台以守护态（Daemonized）形式运行。此时，可以通过添加-d参数来实现。

#### 4.2 停止容器

1、可以使用docker [container] pause CONTAINER [CONTAINER...]命令来暂停一个运行中的容器。

处于paused状态的容器，可以使用docker [container] unpause CONTAINER [CONTAINER...]命令来恢复到运行状态。

2、可以使用docker [container] stop来终止一个运行中的容器。该命令的格式为docker [container]stop [-t|--time[=10]] [CONTAINER...]。

可以通过docker [container] kill直接发送SIGKILL信号来强行终止容器。

3、执行docker container prune命令，会自动清除掉所有处于停止状态的容器。

4、可以用docker ps -qa命令看到所有容器的ID。

5、处于终止状态的容器，可以通过docker [container] start命令来重新启动。

6、docker [container] restart命令会将一个运行态的容器先终止，然后再重新启动。

#### 4.3 进入容器

1、docker attach命令进入容器。

2、Docker提供了一个方便的工具exec命令，可以在运行中容器内直接执行任意命令。

3、通过exec命令对容器执行操作是最为推荐的方式。attach不推荐。

#### 4.4 删除容器

1、可以使用docker [container] rm命令来删除处于终止或退出状态的容器。

#### 4.5 导入和导出容器

1、导出容器是指，导出一个已经创建的容器到一个文件，不管此时这个容器是否处于运行状态。可以使用docker [container] export命令。

2、导出的文件又可以使用docker [container] import命令导入变成镜像。

3、既可以使用docker load命令来导入镜像存储文件到本地镜像库，也可以使用docker[container] import命令来导入一个容器快照到本地镜像库。这两者的区别在于：容器快照文件将丢弃所有的历史记录和元数据信息（即仅保存容器当时的快照状态），而镜像存储文件将保存完整记录，体积更大。

#### 4.6 查看容器

1、查看容器详情可以使用docker container inspect [OPTIONS] CONTAINER [CONTAINER...]子命令。

2、查看容器内进程可以使用docker [container] top [OPTIONS] CONTAINER [CONTAINER...]子命令。

3、查看统计信息可以使用docker [container] stats [OPTIONS] [CONTAINER...]子命令，会显示CPU、内存、存储、网络等使用情况的统计信息。

#### 4.7 其他容器命令

1、container cp命令支持在容器和主机之间复制文件。

2、container diff查看容器内文件系统的变更。

3、container port命令可以查看容器的端口映射情况。

### 第5章 访问Docker仓库

1、仓库（Repository）是集中存放镜像的地方，又分公共仓库和私有仓库。

2、注册服务器是存放仓库的具体服务器，一个注册服务器上可以有多个仓库，而每个仓库下面可以有多个镜像

#### 5.1 DockerHub公共镜像市场

1、Docker Hub是Docker官方提供的最大的公共镜像仓库。

2、可以通过命令行执行docker login命令来输入用户名、密码和邮箱来完成注册和登录。注册成功后，本地用户目录下会自动创建．docker/config.json文件，保存用户的认证信息。

3、Docker镜像分为两种。

一种是类似于centos这样的基础镜像，也称为根镜像。这些镜像是由Docker公司创建、验证、支持、提供，这样的镜像往往使用单个单词作为名字；

另一种类型的镜像，比如ansible/centos7-ansible镜像，是由Docker用户ansible创建并维护的，带有用户名称为前缀，表明是某用户下的某仓库。可以通过用户名称前缀“user_name/镜像名”来指定使用某个用户提供的镜像。

4、自动创建允许用户通过Docker Hub指定跟踪一个目标网站（目前支持GitHub或BitBucket）上的项目，一旦项目发生新的提交，则自动执行创建。

### 第6章 Docker数据管理

1、在生产环境中使用Docker，往往需要对数据进行持久化，或者需要在多个容器之间进行数据共享，这必然涉及容器的数据管理操作。

2、容器中的管理数据主要有两种方式。

数据卷（Data Volumes）：容器内数据直接映射到本地主机环境；

数据卷容器（Data Volume Containers）：使用特定容器维护数据卷。

#### 6.1 数据卷

1、数据卷（Data Volumes）是一个可供容器使用的特殊目录，它将主机操作系统目录直接映射进容器，类似于Linux中的mount行为。

2、Docker提供了volume子命令来管理数据卷

volume create命令创建数据卷，数据卷默认创建在/var/lib/docker/volumes路径下。

除了create子命令外，docker volume还支持inspect（查看详细信息）、ls（列出已有数据卷）、prune（清理无用数据卷）、rm（删除数据卷）等。

3、可以在创建容器时将主机本地的任意路径挂载到容器内作为数据卷，这种形式创建的数据卷称为绑定数据卷。

在用docker [container] run命令的时候，可以使用-mount选项来使用数据卷。

本地目录的路径必须是绝对路径，容器内路径可以为相对路径。如果目录不存在，Docker会自动创建。

#### 6.2 数据卷容器

1、如果用户需要在多个容器之间共享一些持续更新的数据，最简单的方式是使用数据卷容器。数据卷容器也是一个容器，但是它的目的是专门提供数据卷给其他容器挂载。

2、其他容器中使用--volumes-from来挂载dbdata容器中的数据卷。

### 第7章 端口映射与容器互联

1、在实践中，经常会碰到需要多个服务组件容器共同协作的情况，这往往需要多个容器之间能够互相访问到对方的服务。

2、Docker除了通过网络访问外，还提供了两个很方便的功能来满足服务访问的基本需求：一个是允许映射容器内应用的服务端口到本地宿主主机；另一个是互联机制实现多个容器间通过容器名来快速访问。

#### 7.1 端口映射实现容器访问

1、当容器中运行一些网络应用，要让外部访问这些应用时，可以通过-P或-p参数来指定端口映射。当使用-P（大写的）标记时，Docker会随机映射一个49000～49900的端口到内部容器开放的网络端口。

2、使用docker port来查看当前映射的端口配置，也可以查看到绑定的地址。

#### 7.2 互联机制实现便捷互访

1、容器的互联（linking）是一种让多个容器中的应用进行快速交互的方式。它会在源和接收容器之间创建连接关系，接收容器可以通过容器名快速访问到源容器，而不用指定具体的IP地址。

2、使用--name标记可以为容器自定义命名。

3、使用--link参数可以让容器之间安全地进行交互。

--link参数的格式为--link name:alias，其中name是要链接的容器的名称，alias是别名。

4、Docker相当于在两个互联的容器之间创建了一个虚机通道，而且不用映射它们的端口到宿主主机上。

### 第8章 使用Dockerfile创建镜像

1、Dockerfile是一个文本格式的配置文件，用户可以使用Dockerfile来快速创建自定义的镜像。

#### 8.1 基本结构

1、Dockerfile由一行行命令语句组成，并且支持以#开头的注释行。

2、一般而言，Dockerfile主体内容分为四部分：基础镜像信息、维护者信息、镜像操作指令和容器启动时执行指令。

3、主体部分首先使用FROM指令指明所基于的镜像名称，接下来一般是使用LABEL指令说明维护者信息。

4、镜像操作指令，例如RUN指令将对镜像执行跟随的命令。每运行一条RUN指令，镜像添加新的一层，并提交。最后是CMD指令，来指定运行容器时的操作命令。

#### 8.2 指令说明

1、Dockerfile中指令的一般格式为INSTRUCTION arguments，包括“配置指令”（配置镜像信息）和“操作指令”（具体执行操作）。

2、配置指令

ARG定义创建镜像过程中使用的变量。

FROM指定所创建镜像的基础镜像。

LABEL指令可以为生成的镜像添加元数据标签信息。这些信息可以用来辅助过滤出特定镜像。

EXPOSE指令声明镜像内服务监听的端口。

ENV指定环境变量，在镜像生成过程中会被后续RUN指令使用，在镜像启动的容器中也会存在。

ENTRYPOINT指定镜像的默认入口命令，该入口命令会在启动容器时作为根命令执行，所有传入值作为该命令的参数。

VOLUME创建一个数据卷挂载点。

USER指定运行容器时的用户名或UID，后续的RUN等指令也会使用指定的用户身份。

WORKDIR为后续的RUN、CMD、ENTRYPOINT指令配置工作目录。

ONBUILD指定当基于所生成镜像创建子镜像时，自动执行的操作指令。

3、操作指令

RUN运行指定命令。每条RUN指令将在当前镜像基础上执行指定命令，并提交为新的镜像层。当命令较长时可以使用\来换行。

CMD指令用来指定启动容器时默认执行的命令。每个Dockerfile只能有一条CMD命令。如果指定了多条命令，只有最后一条会被执行。如果用户启动容器时候手动指定了运行的命令（作为run命令的参数），则会覆盖掉CMD指定的命令。

COPY复制内容到镜像。复制本地主机的`<src>`（为Dockerfile所在目录的相对路径，文件或目录）下内容到镜像中的`<dest>`。目标路径不存在时，会自动创建。

#### 8.3 创建镜像

1、编写完成Dockerfile之后，可以通过docker [image] build命令来创建镜像。

2、该命令将读取指定路径下（包括子目录）的Dockerfile，并将该路径下所有数据作为上下文（Context）发送给Docker服务端。Docker服务端在校验Dockerfile格式通过后，逐条执行其中定义的指令，碰到ADD、COPY和RUN指令会生成一层新的镜像。最终如果创建镜像成功，会返回最终镜像的ID。

#### 8.4 最佳实践

## 第二部分 实战案例

### 第9章 操作系统

1、社区推出了精简版的linux操作系统Busybox和Alphine。

2、使用Docker，只需要一个命令就能快速获取一个Linux发行版镜像，这是以往各种虚拟化技术都难以实现的。这些镜像一般都很精简，但是可以支持完整Linux系统的大部分功能。

#### 9.1 BusyBox

1、BusyBox是一个集成了一百多个最常用Linux命令（如cat、echo、grep、mount、telnet等）的精简工具箱，它只有不到2 MB大小，被誉为“Linux系统的瑞士军刀”。

#### 9.2 Alpine

1、Alpine操作系统是一个面向安全的轻型Linux发行版，关注安全，性能和资源效能。在保持瘦身的同时，Alpine还提供了包管理工具apk查询和安装软件包。

2、目前Docker官方推荐使用Alpine作为默认的基础镜像环境，这可以带来多个优势，如镜像下载速度加快、镜像安全性提高、主机之间的切换更方便、占用更少磁盘空间等。

### 第10章 为镜像添加SSH服务

1、当需要远程登录到容器内进行一些操作的时候，就需要SSH的支持了。本章具体介绍如何自行创建一个带有SSH服务的镜像。

#### 10.1 基于commit命令创建

1、配置软件源

apt-get update

2、安装和配置SSH服务

安装ssh服务

```shell
apt install openssh-server
```

创建ssh运行目录并启动sshd服务

```shell
mkdir -p /var/run/sshd
/usr/sbin/sshd -D &
```

查看容器的22号端口

```shell
netstat -tunlp
```

修改ssh的安全登录配置，取消pam登录限制

```

```

在root目录下创建.ssh目录，复制需要登录的密钥信息到authorized_keys文件中

公钥一般在本地用户目录的.ssh/id_rsa.pub文件中，可以由ssh-keygen -t rsa命令生成

```shell
mkdir /root/.ssh
```

创建sshd服务的启动脚本run.sh

```shell
#!/bin/bash
/usr/sbin/sshd -D
```

3、保存镜像

保存新的sshd:ubuntu镜像

```shell
docker commit ${docker image id} sshd:ubuntu
```

4、使用镜像

启动容器，并添加端口映射10022->22

```
docker run -p 10022:22 -d sshd:ubuntu /run.sh
```

5、访问镜像

使用ssh访问

```shell
ssh ${ip} -p port
```



## 笔记

1、第一章的内容比较通俗，概括地介绍了Docker的发展历史和基本概念。

2、第二章的内容也比较少，主要了解一下镜像、容器和仓库三大概念。

3、第三章介绍镜像，主要记住镜像的显示、拉取、删除的几个命令即可。

4、很重要的一章，记住容器相关的创建、运行、删除、进入操作。

5、第五章介绍仓库相关操作，实际应用中有关仓库的操作较少。

6、第六章介绍数据卷和数据卷容器，命令选项比较多。

7、第七章介绍了端口映射和容器互联，实践中再详细操作。

8、第八章介绍了使用Dockerfile创建镜像的方法，比较重要。